@model Application.DTO.Mail.EmailMessageBase
@using Application.DTO.Mail
@using Shared.Helper

@{
    var replyModel= new ReplyEmailDTO()
    {
        Uid = Model.Uid,
        De = Model.De,
        Para = Model.Para,
        Asunto = Model.Asunto,
        Adjuntos = Model.Adjuntos,

    };

    var forwardModel = new ForwardEmailDto()
    {
        Uid = Model.Uid,
        De = Model.De,
        Para = Model.Para,
        Asunto = Model.Asunto,
        
    };

}

@{
    ViewData["HeaderTitle"] = "Leer Mensaje ";
    ViewData["Title"] = @Model.Asunto;
    ViewData["CardTitle"] = @Model.Asunto;
    ViewBag.IsSearch = 0;
    ViewData["LinkController"] = "Home";
    ViewData["LinkAction"] = "Index";
    ViewData["LinkText"] = "Volver a la bandeja de entrada";
}
<div class="col-md-3">
    <section class="card">
        <div class="card-header">
            <h3 class="card-title">¿Cómo deseas redactar el mensaje?</h3>
            <div class="card-tools">
                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                    <i class="fas fa-minus"></i>
                </button>
            </div>
        </div>

        <div class="card-body p-0">
            <ul class="nav nav-pills flex-column">
                <li class="nav-item">
                    <a asp-action="Redactar" asp-controller="Redactar" class="nav-link">
                        <i class="fas fa-edit text-primary"></i>
                        <strong>Redacción libre</strong><br />
                        <small class="text-muted">Escribe el mensaje desde cero</small>
                    </a>
                </li>
                <li class="nav-item">
                    <a asp-action="Plantilla" asp-controller="Redactar" class="nav-link">
                        <i class="fas fa-file-alt text-success"></i>
                        <strong>Usar plantilla</strong><br />
                        <small class="text-muted">Basado en un diseño predefinido</small>
                    </a>
                </li>
                <li class="nav-item">
                    <a asp-action ="Index" asp-controller="Home" class="nav-link">
                        <i class="fas fa-arrow-left text-primary"></i>
                        <strong>Volver a la bandeja de entrada</strong><br />

                    </a>
                </li>
            </ul>
        </div>
    </section>
</div>

<div class="col-md-9">
    <div class="card card-primary card-outline">
        <div class="card-header">
            <h2 class="card-title">@ViewData["CardTitle"]</h2>

            @if (ViewBag.IsSearch != 0)
            {
                <div class="card-tools">
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control" placeholder="Search Mail">
                        <div class="input-group-append">
                            <div class="btn btn-primary">
                                <i class="fas fa-search"></i>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
        @Html.Partial("~/Views/Shared/Mail/_Detalle.cshtml", Model)
        <!-- /.card-footer -->
        <div class="card-footer bg-white" ">

            @Html.Partial("~/Views/Shared/Mail/_ImagenesAdjuntos.cshtml", Model)

            @Html.Partial("~/Views/Shared/Mail/_Adjuntos.cshtml", Model)
            


            <div class="float-right">
                <button class="btn btn-default" type="button" data-bs-toggle="collapse" data-bs-target="#collapseResponder" aria-expanded="false"
                        aria-controls="collapseResponder">
                    <i class="fas fa-reply"></i>  Responder
                </button>

                <button type="button" class="btn btn-default" type="button" data-bs-toggle="collapse" data-bs-target="#collapseReenviar" aria-expanded="false"
                        aria-controls="collapseReenviar" >
                    <i class="fas fa-share"></i> Reenviar
                </button>
            </div>
            <button type="button" class="btn btn-default"><i class="far fa-trash-alt"></i> Delete</button>
            <button type="button" class="btn btn-default"><i class="fas fa-print"></i> Print</button>
        </div>

        @Html.Partial("~/Views/Shared/Mail/_Responder.cshtml", replyModel)
        @Html.Partial("~/Views/Shared/Mail/_Reenviar.cshtml", forwardModel)
    </div>
   
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ... (tu lógica de cerrar otros collapsibles) ...

            

            // Para el textarea dentro del colapsable de "Responder"
            const collapseResponder = document.getElementById('collapseResponder');
            if (collapseResponder) {
                collapseResponder.addEventListener('shown.bs.collapse', function () {
                    // Solo inicializa si no ha sido inicializado ya
                    if (!$('#summernote').data('summernote')) {
                        $('#summernote').summernote();
                    }
                });
            }

            // Si tienes otro summernote para reenviar, haz lo mismo
            const collapseReenviar = document.getElementById('collapseReenviar');
            if (collapseReenviar) {
                collapseReenviar.addEventListener('shown.bs.collapse', function () {
                    // ... inicializa el summernote para reenviar si existe
                });
            }
        });
       
             $(function () {
                 $('#Contenido').summernote({
                     height: 300,
                     callbacks: {
                         onImageUpload: function (files) {
                             const input = document.getElementById('imagenes');
                             const dataTransfer = new DataTransfer();

                             for (let j = 0; j < input.files.length; j++) {
                                 dataTransfer.items.add(input.files[j]);
                             }

                             for (let i = 0; i < files.length; i++) {
                                 const file = files[i];

                                 const reader = new FileReader();
                                 reader.onload = function (e) {
                                     $('#Contenido').summernote('insertImage', e.target.result, file.name);
                                 };
                                 reader.readAsDataURL(file);

                                 dataTransfer.items.add(file);
                             }

                             input.files = dataTransfer.files;
                         }
                     }
                 });

                 // Mostrar nombres de archivos adjuntos seleccionados
                 $('#ArchivosAdjuntos').on('change', function () {
                     const lista = $('#listaAdjuntos');
                     lista.empty();

                     for (let i = 0; i < this.files.length; i++) {
                         const file = this.files[i];
                         lista.append(`<div><i class="fas fa-paperclip"></i> ${file.name}</div>`);
                     }
                 });
             });
    
    </script>
}