@using Shared.Helper
@model Application.DTO.Mail.ReplyEmailDTO

@{
    var fechaFormateada = FechaHelper.FormatearDesdeTexto(Model.Fecha);
}

<!-- Inicio Reponder Collapse -->
<section class="collapse  p-3" id="collapseResponder">
    <form asp-action="Responder" asp-controller="Redactar" method="post">
        @Html.AntiForgeryToken()

        <section class="d-flex gap-2">
            <figure>
                <img class="rounded-circle" src="https://lh3.googleusercontent.com/a/ACg8ocKeatyERJ8DYrxH5jTP2L2gvAHf9f6n8ferdsq2-6OrA4-wCw=s40-p-mo" alt="" srcset="">
            </figure>

            <article class="card card-outline ">
                <header class="card-header d-flex">
                    <div>
                        <button type="button" class="btn btn-default dropdown-toggle dropdown-hover dropdown-icon" data-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-reply"></i> <span class="sr-only"></span>
                        </button>

                        <menu class="dropdown-menu">
                            <a class="dropdown-item" data-bs-toggle="collapse" href="#collapseResponder" onclick="removeCollapseResponder()"> <i class="fas fa-reply"></i>  Responder</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" data-bs-toggle="collapse" href="#collapseReenviar" onclick="removeCollapseReenviar()"> <i class="fas fa-share"></i> Reenviar</a>
                            <!-- <a class="dropdown-item" href="#">Editar Asunto</a> -->
                        </menu>
                    </div>
                    <h3 class="card-title ml-1 pt-2 ">
                        @Model.Para
                        <br />
                        @Model.De

                    </h3>
                </header>
                <section class="p-2">
                    <div class="form-floating">
                        <textarea class="form-control" placeholder="Ingrese su contenido de respuesta" asp-for="@Model.ContenidoRespuesta"></textarea>

                        <section class="card-body">
                            <cite class="text-muted">
                                @fechaFormateada, @Model.De escribió:
                                <b>@Model.Asunto</b>
                                @Html.Raw(Model.Contenido)


                            </cite>

                            <input type="hidden" asp-for="Asunto" value="@Model.Asunto" />
                            <input type="hidden" asp-for="Fecha" value="@Model.Fecha" />

                            <input type="hidden" asp-for="De" value="@Model.De" />
                            <input type="hidden" asp-for="Para" value="@Model.Para" />
                            <input type="hidden" asp-for="Uid" value="@Model.Uid" />

                            @if (Model.Adjuntos != null && Model.Adjuntos.Any(a => a.EsImagen))
                            {
                                <div class="mt-4">
                                    <h6><i class="fas fa-image"></i> Imágenes adjuntas:</h6>
                                    <ul class="list-group">
                                        @foreach (var imagen in Model.Adjuntos.Where(a => a.EsImagen))
                                        {
                                            <input type="hidden" asp-for="Adjuntos" value="@Model.Adjuntos" />
                                            var base64 = Convert.ToBase64String(imagen.Datos);
                                            var dataUrl = $"data:{imagen.TipoMime};base64,{base64}";
                                            var nombreArchivo = Uri.EscapeDataString(imagen.Nombre);

                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <span>@imagen.Nombre</span>
                                                <a class="btn btn-sm btn-outline-secondary"  href="@dataUrl" download="@nombreArchivo">
                                                    <i class="fas fa-download"></i> Descargar
                                                </a>
                                            </li>
                                        }
                                    </ul>
                                </div>
                            }

                            @if (Model.Adjuntos != null && Model.Adjuntos.Any(a => !a.EsImagen))
                            {
                                <div class="mt-4">
                                    <h6><i class="fas fa-paperclip"></i> Archivos adjuntos:</h6>
                                    <ul class="list-group">
                                        @foreach (var archivo in Model.Adjuntos.Where(a => !a.EsImagen))
                                        {
                                            var base64 = Convert.ToBase64String(archivo.Datos);
                                            var dataUrl = $"data:{archivo.TipoMime};base64,{base64}";
                                            var nombreArchivo = Uri.EscapeDataString(archivo.Nombre);

                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <span>@archivo.Nombre</span>
                                                <a class="btn btn-sm btn-outline-secondary" href="@dataUrl" download="@nombreArchivo">
                                                    <i class="fas fa-download"></i> Descargar
                                                </a>
                                            </li>
                                        }
                                    </ul>
                                </div>
                            }

                        </section>>
                    </div>
                </section>
            </article>
        </section>
        <button class="btn btn-primary ml-5">Enviar</button>
    </form>
</section>
<!-- Fin Reponder Collapse -->